---
title: "Cardiac troponin measurements"
date: 2016-10-04
output:
  html_document:
    toc: true
    toc_float: true
---

**Last updated:** `r Sys.Date()`

**Code version:** `r system("git log -1 --format='%H'", intern = TRUE)`

```{r chunk-options}
library("knitr")
opts_chunk$set(fig.width = 8, fig.heigth = 8, cache = FALSE)
```

This analysis processes the cardiac troponin measurements.
These are contained in the file `data/troponin.txt`.
This file was created by `code/troponin-extract.R`.

I take the following steps:

1. Calculate the mean absorbance across the two wells per sample for each plate reading.
2. Calculate the standard curve per plate reading using least squares regression.
3. Convert the absorbance values to concentration (ng/mL) using the slope and intercept of the standard curve.
4. Calculate the mean concentration across the two plate readings per sample.

Both the intra-plate (difference between two wells in same reading) and inter-plate (difference between the same well across two plate readings) variabilities are ignored by this analsyis.
I think it is possible to incorporate something like [propogation of uncertainty][uncertain] into this analysis, but I don't immediately remember how to do this, and I'm skeptical it will make much of a difference anyways.

[uncertain]: https://en.wikipedia.org/wiki/Propagation_of_uncertainty#Example_formulas

## Setup

```{r packages, message=FALSE}
library("dplyr")
library("ggplot2")
library("cowplot")
```

Input annotation.

```{r anno}
anno <- read.delim("../data/annotation.txt", stringsAsFactors = FALSE)
```

Input cardiac troponin measurements.

```{r troponin}
troponin <- read.delim("../data/troponin.txt", stringsAsFactors = FALSE)
```

Validate input.
Not all the samples have the correct replicate of the cell line. Need to investigate the difference between the replicates.

```{r validate}
stopifnot(troponin$dosage[troponin$type == "unknown"] %in% anno$dosage)
cell_line_input <- unique(troponin$cell_line[troponin$type == "unknown"])
cell_line_input <- sort(cell_line_input)
cell_line_valid <- cell_line_input %in% anno$cell_line
names(cell_line_valid) <- cell_line_input
length(cell_line_valid)
sum(cell_line_valid)
cell_line_valid
sort(unique(anno$cell_line))
```

Convert dosage of C to 0.

```{r}
anno$dosage[anno$dosage == "C"] <- 0
anno$dosage <- as.numeric(anno$dosage)
troponin$dosage[troponin$dosage == "C"] <- 0
troponin$dosage <- as.numeric(troponin$dosage)
```

## Calculate the intra-plate mean and sd

```{r}
tr_intra <- troponin %>%
  group_by(experiment, reading, name, type, cell_line, dosage, known_conc) %>%
  summarize(mean_intra = mean(absorbance),
            sd_intra = sd(absorbance),
            cv_intra = sd_intra / mean_intra * 100) %>%
  ungroup
stopifnot(nrow(tr_intra) <= nrow(troponin) / 2)
# There are fewer entries because the experiments on 11/5/15 had fewer samples.
# table(tr_intra$experiment, tr_intra$reading)
```

```{r}
ggplot(tr_intra, aes(x = mean_intra, y = cv_intra)) +
  geom_point() +
  geom_smooth() +
  facet_wrap(~type, scales = "free_x")
```

## Convert absorbance to concentration using the standard curve

Calculate slope and intercept of standard curve.

```{r curve}
std_curve <- tr_intra %>%
  group_by(experiment, reading) %>%
  do(mod = lm(mean_intra ~ known_conc, data = .)) %>%
  do(data.frame(experiment = .$experiment,
                reading = .$reading,
                intercept = coef(.$mod)[1],
                slope = coef(.$mod)[2],
                r2 = summary(.$mod)$r.squared))
```

Convert absorbance to concentration.

```{r}
tr_intra$conc <- NA
for (i in 1:nrow(tr_intra)) {
  std_curve_sub <- std_curve %>%
    filter(experiment == tr_intra$experiment[i],
           reading == tr_intra$reading[i])
  # x = (y - b) / m
  b <- std_curve_sub %>% select(intercept) %>% as.numeric
  m <- std_curve_sub %>% select(slope) %>% as.numeric
  tr_intra$conc[i] <- (tr_intra$mean_intra[i] - b) / m
}
```

## Calculate the inter-plate mean and sd

```{r}
tr_inter <- tr_intra %>%
  group_by(experiment, name, type, cell_line, dosage, known_conc) %>%
  summarize(mean_inter = mean(conc),
            sd_inter = sd(conc),
            cv_inter = sd_inter / mean_inter * 100) %>%
  ungroup
stopifnot(nrow(tr_inter) == nrow(tr_intra) / 2)
```

## Merge

Merge the annotation and troponin data.

```{r merge}
anno <- anno %>% select(id:dosage)
d <- merge(anno, tr_inter)
dim(d)
length(unique(d$findiv))
```

Which individuals do not have a troponin measurement?

```{r}
sort(setdiff(anno$cell_line, d$cell_line))
```

Which individuals have a troponin measurement for their replicate which differs from the replicate that was sequenced?

```{r}
sort(setdiff(tr_inter$cell_line, d$cell_line))
```

It appears that for each individual that does not have a troponin measurement, the measurement was performed on a different (or unspecified) replicate.
I need to investigate 1) what is the difference between replicates (I think different differentations from iPSC to cardiomyocytes) and 2) if it is valid to compare the troponin and gene expression levels across replicates.

## Plots

Focus on the unknown samples for the inidividuals.

```{r}
d_ind <- d[d$type == "unknown", ]
```

Increase in cardiac troponin with increasing concentrations of dox.

```{r}
tr_v_dox <- ggplot(d_ind,
                   aes(x = as.factor(dosage), y = mean_inter)) +
  geom_boxplot() +
  labs(x = "Doxorubicin dosage",
       y = "Cardiac troponin concentration (ng/mL)",
       title = "Cardiac troponin levels increase with increasing doxorubicin dosage")
```

Classify individuals by how large their release of cardiac troponin is.

```{r}
tr_max <- tapply(d_ind$mean_inter, d_ind$findiv, max)
tr_max_q <- quantile(tr_max, probs = c(0.25, 0.75))
response <- tr_max
response[tr_max <= tr_max_q[1]] <- "blue" # low
response[tr_max >= tr_max_q[2]] <- "red" # high
response[tr_max > tr_max_q[1] & tr_max < tr_max_q[2]] <- "black" # intermediate
table(response)
```

Variation between individuals.

```{r}
tr_var <- ggplot(d_ind, aes(x = dosage, y = mean_inter,
                            color = as.factor(findiv))) +
  geom_point() +
  geom_line(linetype = "dashed") +
  theme(legend.position = "none") +
  # scale_color_grey() +
  scale_color_manual(values = response) +
  labs(x = "Doxorubicin dosage",
       y = "Cardiac troponin concentration (ng/mL)",
       title = "Cardiac troponin levels vary across individuals")
```

Combined figure.

```{r fig.width=14}
plot_grid(tr_v_dox, tr_var, labels = LETTERS[1:2])
```

## Session information

```{r info}
sessionInfo()
```
