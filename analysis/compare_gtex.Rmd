---
title: "Compare to GTEx heart_all eQTL"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
require(data.table)
require(ggplot2)
theme_set(theme_bw(base_size = 15))
```

```{r}
source("load_gtex_eqtl.R")
```

```{r}
eqtl = fread("zcat < ../data/panana_all_eqtl.txt.gz", data.table = F)
```

```{r}
source("../code/utils.R")
geno_bf=eqtl %>% mutate(p=p_geno) %>% bonferroni
geno_threshold=geno_bf %>% filter(q<.05) %>% .$p %>% max
geno_threshold
sum(geno_bf$q < 0.05) # 202, 674
```

Nominal p of 1e-5 is roughly cutoff for nomimal FDR 0.05. 
```{r}
require(qvalue)
geno_threshold=1e-5
replication_rates = foreach(tis_n=names(gtex_tis), .combine = bind_rows) %dopar% {
  tis=gtex_tis[[tis_n]]
  eqtl_join_gtex = eqtl %>% inner_join(tis, by=c(gene="gene_id", RSID="RSID"))

  rep_p = eqtl_join_gtex %>% filter(p_geno < geno_threshold) %>% .$pval_nominal
  
  data.frame( tissue=tis_n, prop_shared=nrow(eqtl_join_gtex)/nrow(eqtl), naive_rep= mean(rep_p < 0.05), p1= 1. - pi0est(rep_p)$pi0, stringsAsFactors = F)
}
replication_rates %>% mutate(tissue=factor(tissue,c("brain","lcl","heart"),c("Brain (Cerebellum)","Lymphoblastoid cell line","Heart (Left Ventricle)"))) %>% ggplot(aes(tissue, p1)) + geom_bar(stat='identity') + xlab("GTEx tissue") + ylab("Storey's pi1") + theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) + ylim(0,1)
ggsave("../figures/gtex.pdf",width=3,height=4)
```


```{r}
eqtl_join_gtex = eqtl %>% inner_join(gtex_tis$heart, by=c(gene="gene_id", RSID="RSID"))
bonferroni_with_gtex=function(g) { g %>% group_by(gene) %>% 
    summarize( cis_snp=cis_snp[which.min(p)], p=min(p) * length(p), gtex_p=pval_nominal[which.min(p)]  ) %>% 
    mutate( q=p %>% pmin(1) %>% p.adjust(method="BH") ) }
geno_at_gtex=eqtl_join_gtex %>% mutate(p=p_geno) %>% bonferroni_with_gtex
gtex_p_at_sig=geno_at_gtex %>% filter(q<0.05) %>% .$gtex_p
mean( gtex_p_at_sig< 0.05 )
hist(gtex_p_at_sig,100)
1-qvalue(gtex_p_at_sig)$pi0
```

## GWAS enrichment in GTEX

```{r}
head(gtex_tis$heart)
gwas_df = fread("zcat < ../data/schneider_gwas_clean.txt.gz", data.table = F)
```

```{r}
join_all = gtex_tis$heart %>% inner_join(gwas_df, by="RSID")
p_range=outer( c(5,1), 10^-seq(1,5)) %>% as.numeric() %>% tail(-1)
```

```{r}
gtex_sig = gtex_tis$heart %>% rename(gene=gene_id, cis_snp=variant_id) %>% mutate(p=pval_nominal) %>% bonferroni()
sum(gtex_sig$q < 0.05)
gtex_sig_threshold=max(gtex_sig %>% filter(q<.05) %>% .$p)
gtex_sig_threshold
```
```{r}
enrich_results=foreach(p_eqtl = p_range, .combine = bind_rows ) %dopar% {
  foreach(p_gwas = p_range, .combine = bind_rows ) %do% {
    gwas_hits = join_all$Pvalue < p_gwas
    #eqtl_hits = join_all$p_joint < p_eqtl
    #eqtl_hits = (join_all$p_geno < p_eqtl) | (join_all$p_interact < p_eqtl)
    eqtl_hits = join_all$pval_nominal < p_eqtl
    ft  = fisher.test( gwas_hits, eqtl_hits, alternative="greater" )
    data.frame( p_eqtl = p_eqtl, p_gwas=p_gwas, n_eqtl=sum(eqtl_hits), gwas_hits=sum(gwas_hits),  overlap=sum(gwas_hits & eqtl_hits), OR=ft$estimate, p = ft$p.value)
  }
}
enrich_results
enrich_results %>% mutate(p_eqtl=as.factor(p_eqtl), p_gwas=as.factor(p_gwas)) %>% ggplot(aes(p_eqtl,p_gwas, fill=log(OR), label=paste( format(p,digits=1), format(OR,digits=1)))) + geom_tile() + geom_text() + theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) + scale_fill_gradient2()
```

```{r}
pvalue_qqplot_multi_thin(join_all %>% mutate(p=Pvalue, group=factor( pval_nominal < 1e-5, c(F,T), c("No eQTL","eQTL"))) %>% select(p,group), nl10_obs_p_threshold = 1) + scale_color_manual(values=cbPalette) + theme(legend.position = c(0.8,0.2),legend.title = element_blank())+ expand_limits(x=1, y=1) 
```

